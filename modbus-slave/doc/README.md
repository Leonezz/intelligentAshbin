# 基于 FreeMODBUS 的stm32 modbus 从机系统

## 外设

系统目前维护传感器和推杆等共 4 个外设，分别是：

- 温湿度传感器`YSAT01B`（串口）
- 可燃气体传感器`MQ-2`（ADC）
- 称重传感器（ADC）
- 推杆（继电器/普通IO）
- 扫码器
- 超声波传感器
- 红外接近开关

## 寄存器分配

系统数据大致分为两类：只读数据（传感器数值）和只写数据（推杆状态）
对于只读数据，将其储存在输入寄存器`usRegInputBuf`中，数据类型为`unsigned short`，寄存器长度为20，分配如下：

| 地址  | 0x00  | 0x01  |     0x02     | 0x03-0x04 |     0x05     | 0x06-0x12 |      0x13      |   0x14   |
| :---: | :---: | :---: | :----------: | :-------: | :----------: | :-------: | :------------: | :------: |
| 数据  | 温度  | 湿度  | 可燃气体浓度 |   重量    | 用户ID时效性 |  用户ID   | 超声波测距数据 | 桶满状态 |

推杆状态信息存储在线圈寄存器中，其地址为`0x00`，长度为`1`

## 读取指令数据帧格式：

| 从机地址 | 功能代码 | 寄存器地址高位 | 寄存器地址低位 | 寄存器数量高位 | 寄存器数量低位 | CRC高位 | CRC低位 |
| :------: | :------: | :------------: | :------------: | :------------: | :------------: | :-----: | :-----: |

## 写指令数据帧格式：

| 从机地址 | 功能代码 | 寄存器地址高位 | 寄存器地址低位 | 数据1-数据n | CRC高位 | CRC低位 |
| :------: | :------: | :------------: | :------------: | :---------: | :-----: | :-----: |

## 设备返回数据帧格式：

| 从机地址 | 功能代码 | 返回字节数n | 数据1-数据n | CRC高位 | CRC低位 |
| :------: | :------: | :---------: | :---------: | :-----: | :-----: |


## 目前的`modbus`数据读写指令如下表：

|                   指令                    |       描述       |                    响应示例                    |
| :---------------------------------------: | :--------------: | :--------------------------------------------: |
| `0x01 0x04 0x00 0x00 0x00 0x01 0x31 0xCA` |     读取温度     |      `0x01 0x04 0x02 0x06 0xBA 0x3B 0x23`      |
| `0x01 0x04 0x00 0x01 0x00 0x01 0x60 0x0A` |     读取湿度     |      `0x01 0x04 0x02 0x11 0x17 0xF5 0x6E`      |
| `0x01 0x04 0x00 0x02 0x00 0x01 0x90 0x0A` | 读取可燃气体浓度 |      `0x01 0x04 0x02 0x01 0x0C 0xB8 0xA5`      |
| `0x01 0x04 0x00 0x03 0x00 0x02 0x81 0xCB` |     读取重量     | `0x01 0x04 0x04 0x00 0x00 0x00 0x9B 0xBA 0x2F` |
|`0x01 0x04 0x00 0x05 0x00 0x01 0x21 0xCB`|读取用户ID时效性|`0x01 0x04 0x02 0x00 0x01 0x80 0x49`|
|`0x01 0x04 0x00 0x06 0x00 0x0D 0xD1 0xCE`|读取用户ID|`数据过长，不便展示`|
|`0x01 0x04 0x00 0x13 0x00 0x01 0xC0 0x0F`|读取超声波测距数据|`0x01 0x04 0x02 0x01 0x90 0xB8 0xCC`|
|`0x01 0x04 0x00 0x14 0x00 0x01 0x71 0xCE`|读取桶满状态|`0x01 0x04 0x02 0x00 0x01 0x78 0xF0`|
| `0x01 0x01 0x00 0x00 0x00 0x01 0xFD 0xCA` |   读取推杆状态   |        `0x01 0x01 0x01 0x00 0x51 0x88`         |
| `0x01 0x05 0x00 0x00 0xFF 0x00 0x8C 0x3A` |   推杆状态写1    |   `0x01 0x05 0x00 0x00 0xFF 0x00 0x8C 0x3A`    |
| `0x01 0x05 0x00 0x00 0x00 0x00 0xCD 0xCA` |   推杆状态写0    |   `0x01 0x05 0x00 0x00 0x00 0x00 0xCD 0xCA`    |

## 返回数据解析

对于返回数据帧中的数据1-数据n部分，其解析方式如下：
1. 温度数据
   温度数据长度为2字节，数据为16位长度整数，字节1是温度数值高8位，字节2是温度数值低8位。
   如`0x06 0xBA`所表示的温度数值为：`((0x06 << 8) + 0xBA) / 100 = 17.22℃`
2. 湿度数据
   湿度数据的解析方式与温度数据相同，如`0x11 0x17`所表示的湿度数值为：`((0x11 << 8) + 0x17) / 100 = 43.75%`
3. 可燃气体浓度数据
   可燃气体浓度数据长度为2字节，经由单片机的12位ADC采集，因此其数据实际是模拟电压值。如`0x01 0x0C`所表示的数值为：`(((0x01 << 8) + 0x0C) * 3.3) >> 12 V/3.3V`
4. 重量数据
   重量数据长度为4字节，数值为32位整数，如`0x00 0x00 0x00 0x9B`所表示的数值为：`((((((0x00 << 8) + 0x00) << 8) + 0x00) << 8) + 0x9B) / 100 = 1.55 kg`
5. 用户ID时效性
   用户ID时效性数据长度为2字节，但是其在正常情况下只应有0和1两种数值。0代表用户ID数据已不具时效性，1代表用户ID具有时效性。
6. 用户ID
   用户ID数据长度为13字节，每个字节的数值就是ID字符串对应位置字符的ASCII数值。
7. 超声波测距数据
   超声波测距数据长度为2字节，数值为16位整数，如`0x01 0x90`代表的数值为：`(0x01 << 8) + 0x90 = 400 mm`
8. 桶满状态
   桶满状态数据长度为2字节，但是其在正常情况下只应有0和1两种数值。0代表桶内垃圾未满，1代表桶内垃圾已满。
9. 推杆状态
    推杆状态（垃圾桶盖状态）数据长度为1字节，但是其在正常情况下只应有0和1两种数值。0代表桶盖关闭，1代表桶盖打开。

